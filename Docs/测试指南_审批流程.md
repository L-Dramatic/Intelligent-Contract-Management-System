# 审批流程后端测试指南

## 前置条件

### 1. 数据库初始化

首先需要更新数据库结构和数据。按顺序执行以下SQL：

```bash
# 方式一：完整初始化（开发/测试环境）
mysql -u root -p123456 -h 118.31.77.102 < database/init.sql
mysql -u root -p123456 -h 118.31.77.102 contract_system < database/init_data_v2.sql
mysql -u root -p123456 -h 118.31.77.102 contract_system < database/db_upgrade_v5_complete_scenarios.sql

# 方式二：在 MySQL 客户端中依次执行
# 1. 先执行 database/init.sql（会重建所有表，注意备份！）
# 2. 再执行 database/init_data_v2.sql（初始化组织树和测试数据）
# 3. 最后执行 database/db_upgrade_v5_complete_scenarios.sql（配置完整的34+1个审批场景）
```

> ⚠️ **警告**：`init.sql` 会 DROP 所有现有表，生产环境请使用增量升级脚本。
> 
> 📌 **v5更新说明**：`db_upgrade_v5_complete_scenarios.sql` 包含完整的35个审批场景配置（34个业务场景 + 1个兜底场景），是新版审批引擎的核心配置。

### 2. 启动后端服务

```bash
cd backend
mvn spring-boot:run
# 或者
./mvnw spring-boot:run
```

等待看到 `Started ContractSystemApplication` 后，服务启动成功。

---

## 测试步骤

### 步骤1：基础API测试

使用 VS Code REST Client 插件或 Postman 打开 `test_api_v2.http`。

#### 1.1 测试登录

```http
POST http://localhost:8080/user/login
Content-Type: application/json

{
    "username": "admin",
    "password": "123456"
}
```

**预期响应**：返回 Token

#### 1.2 测试组织树API

```http
GET http://localhost:8080/dept/tree
```

**预期响应**：返回完整的省-市-县三级组织树

---

### 步骤2：核心功能测试

#### 2.1 县级部门→市级部门映射（关键！）

```http
GET http://localhost:8080/dept/153/city-level
```

**预期响应**：
```json
{
    "code": 200,
    "data": {
        "id": 101,
        "name": "A市网络部",
        "code": "CITY-A-NET",
        ...
    }
}
```

这验证了县级部门（C县网络部 id=153）能正确映射到对应的市级部门（A市网络部 id=101）。

#### 2.2 场景匹配测试

```http
GET http://localhost:8080/workflow/scenario/scenarios/A1-Tier2
```

**预期响应**：返回 A1-Tier2 场景配置（土建工程1-5万）及其审批节点列表

---

### 步骤3：完整审批流程测试

这是最重要的端到端测试！

#### 场景：C县员工发起土建工程合同（2万元），走A1-Tier2审批路径

**预期审批流程**：
```
C县员工发起 → A市项目经理审查 → A市成本审计员核实 → A市网络部经理审批 → A市副总经理审批
```

#### 3.1 C县员工登录并创建合同

```http
POST http://localhost:8080/user/login
Content-Type: application/json

{
    "username": "c_net_user",
    "password": "123456"
}
```

记录返回的 Token。

#### 3.2 创建合同

```http
POST http://localhost:8080/contract/create
Content-Type: application/json
Authorization: Bearer <替换为上一步的Token>

{
    "name": "C县基站土建施工合同",
    "type": "A1",
    "partyA": "中国移动XX省A市C县分公司",
    "partyB": "XX建筑工程有限公司",
    "amount": 20000,
    "content": "土建工程施工合同正文..."
}
```

记录返回的 contractId。

#### 3.3 提交审批

```http
POST http://localhost:8080/workflow/submit/<contractId>
Authorization: Bearer <C县员工Token>
```

**预期**：
- 自动匹配 A1-Tier2 场景
- 创建流程实例
- 自动派发任务给A市项目经理

#### 3.4 A市项目经理审批

```http
# 先登录
POST http://localhost:8080/user/login
{"username": "a_pm", "password": "123456"}

# 查看待办
GET http://localhost:8080/workflow/scenario/tasks/pending
Authorization: Bearer <项目经理Token>

# 审批通过
POST http://localhost:8080/workflow/scenario/tasks/<taskId>/approve
Authorization: Bearer <项目经理Token>
{"comment": "技术方案可行"}
```

#### 3.5 继续后续审批...

依次让成本审计员、部门经理、副总经理审批通过。

---

## 测试账号清单

| 用户名 | 密码 | 角色 | 部门 |
|--------|------|------|------|
| admin | 123456 | 系统管理员 | 省公司 |
| a_gm | 123456 | 总经理 | A市分公司 |
| a_vp | 123456 | 副总经理 | A市分公司 |
| a_net_mgr | 123456 | 部门经理 | A市网络部 |
| a_pm | 123456 | 项目经理 | A市网络部 |
| a_cost_audit | 123456 | 成本审计员 | A市财务部 |
| a_legal | 123456 | 法务审查员 | A市法务部 |
| c_net_user | 123456 | 发起人 | C县网络部 |
| c_gov_user | 123456 | 发起人 | C县政企部 |

---

## 新版审批引擎说明

### 引擎切换（v5更新）

从v5版本开始，系统已切换到**新版场景审批引擎**：

| 对比项 | 旧版引擎 | 新版引擎 |
|--------|---------|---------|
| 配置表 | wf_definition + wf_node + wf_transition | wf_scenario_config + wf_scenario_node |
| 匹配方式 | 硬编码defId=1 | 根据子类型+金额自动匹配 |
| 场景数量 | 1个通用流程 | 35个精确场景（34业务+1兜底） |
| 兜底机制 | 无 | FALLBACK-DEFAULT场景 |

### 场景配置统计

| 类别 | 场景数 | 说明 |
|------|--------|------|
| A类-工程施工 | 10个 | A1(4) + A2(4) + A3(2) |
| B类-代维服务 | 13个 | B1(3) + B2(4) + B3(2) + B4(4) |
| C类-IT/DICT | 11个 | C1(4) + C2(3) + C3(4) |
| 兜底场景 | 1个 | FALLBACK-DEFAULT |
| **合计** | **35个** | |

### 合同类型与子类型映射

| 主类型 | 子类型代码 | 子类型名称 |
|--------|-----------|-----------|
| TYPE_A | A1 | 土建工程 |
| | A2 | 装修工程 |
| | A3 | 零星维修 |
| TYPE_B | B1 | 光缆代维 |
| | B2 | 基站代维 |
| | B3 | 家宽代维 |
| | B4 | 应急保障（快速通道）|
| TYPE_C | C1 | 定制开发 |
| | C2 | 商用软件采购 |
| | C3 | DICT集成 |

---

## 常见问题

### Q1: 提交合同时报"未找到匹配的审批场景"
**A**: 检查合同的 `type` 字段是否是有效的主类型（TYPE_A, TYPE_B, TYPE_C），或在 `attributes` 中设置 `subTypeCode`（如 A1, B2, C3）

### Q2: 审批时报"无法找到审批人"
**A**: 检查：
1. 用户是否设置了正确的 `primary_role` 和 `dept_id`
2. 对应部门是否有该角色的用户
3. 县级→市级部门映射是否正确

### Q3: 数据库连接失败
**A**: 检查 `application.properties` 中的数据库配置，确保数据库服务可访问

---

## API 端点汇总

### 组织树
| 方法 | 端点 | 说明 |
|------|------|------|
| GET | /dept/tree | 获取完整组织树 |
| GET | /dept/{id} | 获取部门详情 |
| GET | /dept/children/{parentId} | 获取子部门 |
| GET | /dept/{id}/city-level | 县级部门找市级部门 |

### 角色
| 方法 | 端点 | 说明 |
|------|------|------|
| GET | /role/list | 所有角色 |
| GET | /role/user/{userId} | 用户的角色 |

### 审批流程
| 方法 | 端点 | 说明 |
|------|------|------|
| GET | /workflow/scenario/tasks/pending | 待办任务 |
| POST | /workflow/scenario/tasks/{id}/approve | 审批通过 |
| POST | /workflow/scenario/tasks/{id}/reject | 审批驳回 |
| GET | /workflow/scenario/contract/{id}/progress | 审批进度 |
| GET | /workflow/scenario/contract/{id}/history | 审批历史 |
| GET | /workflow/scenario/scenarios | 所有场景配置 |


