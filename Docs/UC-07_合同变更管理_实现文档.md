# UC-07 合同变更管理 - 实现文档

**实现日期**：2025-12-24  
**实现人员**：AI Assistant  
**对应需求**：软件需求规格说明书 4.2.6 用例UC-07

---

## 一、功能概述

实现了合同变更管理全流程，支持：
- 发起变更申请
- 变更对比视图
- 重大变更判定（金额>20%）
- 变更审批流程
- 版本历史追踪

---

## 二、实现清单

### 后端新增文件

| 路径 | 用途 |
|------|------|
| `mapper/ContractChangeMapper.java` | MyBatis Mapper接口 |
| `dto/ContractChangeDTO.java` | 请求数据传输对象 |
| `dto/ContractChangeVO.java` | 响应视图对象 |
| `service/ContractChangeService.java` | 服务接口 |
| `service/impl/ContractChangeServiceImpl.java` | 服务实现（核心逻辑） |
| `controller/ContractChangeController.java` | REST控制器 |
| `sql/V3__contract_change.sql` | 数据库迁移脚本 |

### 后端修改文件

| 文件 | 修改内容 |
|------|----------|
| `WorkflowService.java` | 新增3个方法声明 |
| `WorkflowServiceImpl.java` | 实现变更审批流程启动/终止 |
| `WfInstance.java` | 新增 `remark` 字段、`STATUS_TERMINATED` 常量 |
| `WfTask.java` | 新增 `STATUS_CANCELLED` 常量 |
| `SecurityConfig.java` | 放行 `/contract-change/**` 接口 |

### 前端新增文件

| 路径 | 用途 |
|------|------|
| `api/contractChange.ts` | API接口封装 |
| `views/contract/ContractChangeCreate.vue` | 发起变更页面 |
| `views/contract/ContractChangeList.vue` | 变更列表页面 |

### 前端修改文件

| 文件 | 修改内容 |
|------|----------|
| `router/index.ts` | 新增2个变更管理路由 |
| `layout/MainLayout.vue` | 侧边栏新增"变更管理"菜单 |
| `views/contract/ContractDetail.vue` | 新增"发起变更"按钮、"变更历史"Tab |

---

## 三、API接口

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | `/contract-change/create` | 创建变更申请（草稿） |
| POST | `/contract-change/{id}/submit` | 提交审批 |
| POST | `/contract-change/{id}/cancel` | 撤销申请 |
| GET | `/contract-change/{id}` | 获取详情 |
| GET | `/contract-change/history/{contractId}` | 获取变更历史 |
| GET | `/contract-change/list` | 分页查询 |
| GET | `/contract-change/my` | 我的变更申请 |
| GET | `/contract-change/can-change/{contractId}` | 检查是否可变更 |
| POST | `/contract-change/check-major` | 重大变更预检 |

---

## 四、核心业务规则

1. **可变更条件**：仅"已生效"状态的合同可发起变更
2. **互斥控制**：同一合同同时只能有一个审批中的变更
3. **重大变更判定**：
   - 金额变更超过原金额20%
   - 技术方案变更（changeType=TECH）
4. **审批流程**：
   - 普通变更：部门经理审批
   - 重大变更：部门经理 → 法务会签 → 分管领导

---

## 五、数据库变更

执行SQL脚本：`backend/sql/V3__contract_change.sql`

**新增表**：`t_contract_change`

**新增审批场景**：
- `CHANGE-NORMAL`：普通变更审批
- `CHANGE-MAJOR`：重大变更审批

---

## 六、测试指南

### 前置条件

1. 数据库执行 `V3__contract_change.sql`
2. 后端服务重启
3. 至少有一个"已生效"状态的合同

### 测试步骤

#### 1. 发起变更

1. 登录系统，进入"合同管理 > 合同列表"
2. 找到一个状态为"已生效"的合同，点击进入详情
3. 点击右上角"发起变更"按钮
4. 填写变更信息：
   - 变更标题（必填）
   - 变更类型（选择"金额变更"）
   - 变更原因（选择任意）
   - 变更说明（必填）
   - 修改"新合同金额"
5. 观察页面底部"变更对比预览"表格是否正确显示
6. 点击"保存草稿"

#### 2. 重大变更检测

1. 在变更页面，将金额改为原金额的1.25倍以上（>20%）
2. 观察页面顶部是否出现红色"重大变更"标签
3. 点击"提交审批"，应弹出确认对话框提示需要法务会签

#### 3. 变更列表

1. 进入"合同管理 > 变更管理"
2. 查看变更申请列表
3. 测试筛选功能（状态筛选、仅看我的）
4. 点击"查看"查看详情抽屉

#### 4. 变更历史

1. 进入已有变更记录的合同详情页
2. 切换到"变更历史"Tab
3. 查看变更时间线是否正确显示

#### 5. 审批流程（需审批权限账号）

1. 用审批人账号登录
2. 进入"审批中心 > 待办任务"
3. 找到变更审批任务，执行审批

### 预期结果

| 操作 | 预期 |
|------|------|
| 已生效合同详情页 | 显示"发起变更"按钮 |
| 非已生效合同 | 不显示"发起变更"按钮 |
| 金额变更>20% | 标记为重大变更 |
| 技术方案变更 | 标记为重大变更 |
| 保存草稿 | 状态为"草稿"，可编辑 |
| 提交审批 | 状态变为"审批中" |
| 撤销申请 | 状态变为"已撤销" |
| 审批通过 | 状态变为"已通过" |

---

## 七、注意事项

1. **实体类**：`ContractChange.java` 已存在，无需重复创建
2. **审批场景**：SQL脚本使用 `INSERT IGNORE`，不会重复插入
3. **权限**：已配置 `/contract-change/**` 为认证即可访问
4. **前端状态**：合同状态为 `APPROVED` 时才显示变更按钮

---

## 八、后续优化建议

- [ ] 变更协议PDF自动生成
- [ ] 附件上传功能
- [ ] 变更审批完成后自动应用到合同
- [ ] 变更邮件通知

