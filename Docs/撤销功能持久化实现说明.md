# 撤销功能持久化实现说明

## 实现概述

实现了方案2：数据库允许NULL方案，支持新建合同（未保存）的撤销功能数据持久化。

## 修改内容

### 1. 数据库迁移脚本
**文件**：`database/db_upgrade_v10_allow_null_contract_id.sql`

**修改内容**：
- 将 `t_contract_edit_history` 表的 `contract_id` 字段改为允许 NULL
- 支持新建合同（contractId为null）的编辑历史持久化存储

**执行方式**：
```sql
-- 在MySQL中执行
source database/db_upgrade_v10_allow_null_contract_id.sql;
-- 或者直接执行SQL语句
ALTER TABLE `t_contract_edit_history` 
MODIFY COLUMN `contract_id` bigint DEFAULT NULL COMMENT '合同ID（新建合同时为NULL）';
```

### 2. 后端代码修改

#### 2.1 修改保存逻辑
**文件**：`backend/src/main/java/com/software/contract_system/service/impl/AIChatServiceImpl.java`

**修改位置**：`parseAndExecuteCommand()` 方法（约347-354行）

**修改前**：
```java
if (request.getContractId() != null) {
    saveEditHistory(...);
}
```

**修改后**：
```java
// 允许contractId为null（新建合同场景），支持数据持久化
saveEditHistory(...);
```

**说明**：移除了contractId的null判断，允许新建合同的编辑历史也保存到数据库。

#### 2.2 修改撤销逻辑
**文件**：`backend/src/main/java/com/software/contract_system/service/impl/AIChatServiceImpl.java`

**修改位置**：`undoAgentAction()` 方法（约194-220行）

**修改内容**：
- 判断 `contractId` 是否为 null
- 如果 `contractId` 不为 null：正常更新数据库中的合同表
- 如果 `contractId` 为 null：只返回内容，不更新数据库（新建合同场景）

**关键逻辑**：
```java
if (history.getContractId() != null) {
    // 已保存合同：更新数据库
    Contract contract = contractMapper.selectById(history.getContractId());
    contract.setContent(restoredContent);
    contractMapper.updateById(contract);
} else {
    // 新建合同：只返回内容，不更新数据库
    log.info("撤销Agent操作（新建合同）: sessionId={}, undoToken={}", ...);
}
```

## 执行步骤

### 步骤1：执行数据库迁移
```bash
# 连接到MySQL数据库
mysql -u root -p contract_system

# 执行迁移脚本
source database/db_upgrade_v10_allow_null_contract_id.sql;
```

或者直接在MySQL中执行：
```sql
ALTER TABLE `t_contract_edit_history` 
MODIFY COLUMN `contract_id` bigint DEFAULT NULL COMMENT '合同ID（新建合同时为NULL）';
```

### 步骤2：重启后端服务
重启Spring Boot后端服务以应用代码更改。

### 步骤3：测试验证
1. **新建合同场景**：
   - 创建新合同（未保存）
   - 使用Agent模式修改合同内容
   - 点击"撤销此操作"按钮
   - 验证：应该能成功撤销，合同内容恢复

2. **已保存合同场景**：
   - 编辑已保存的合同
   - 使用Agent模式修改合同内容
   - 点击"撤销此操作"按钮
   - 验证：应该能成功撤销，数据库中的合同内容也被更新

## 功能说明

### 新建合同场景（contractId = null）
- ✅ 编辑历史保存到数据库（contract_id为NULL）
- ✅ 撤销时从数据库查找记录
- ✅ 撤销后返回内容给前端，前端更新本地内容
- ✅ 数据持久化，服务器重启后仍可撤销

### 已保存合同场景（contractId != null）
- ✅ 编辑历史保存到数据库（contract_id有值）
- ✅ 撤销时从数据库查找记录
- ✅ 撤销后更新数据库中的合同表
- ✅ 前端同步更新内容

## 注意事项

1. **数据库迁移**：
   - 执行迁移前建议备份数据库
   - 迁移是安全的（只是修改字段允许NULL，不会丢失数据）

2. **数据清理**（可选）：
   - 可以添加定时任务清理过期的NULL记录（超过24小时的未保存合同编辑历史）
   - 或手动清理：`DELETE FROM t_contract_edit_history WHERE contract_id IS NULL AND created_at < DATE_SUB(NOW(), INTERVAL 24 HOUR)`

3. **兼容性**：
   - 已有数据不受影响（已有记录的contract_id都是非NULL值）
   - 新功能向后兼容

## 验证清单

- [ ] 数据库迁移脚本执行成功
- [ ] 后端服务重启成功
- [ ] 新建合同场景下撤销功能正常
- [ ] 已保存合同场景下撤销功能正常
- [ ] 服务器重启后撤销功能仍然可用（数据持久化验证）


