# 紧急恢复SSH访问指南

## 当前问题
控制台一键连接也无法连接，可能是UFW防火墙阻止了SSH。

## 解决方案

### 方案1：检查并配置云服务商安全组（推荐）

**无论控制台能否连接，都需要配置安全组！**

#### 阿里云ECS
1. 登录阿里云控制台
2. 进入 **ECS** → **实例** → 找到服务器 `118.31.77.102`
3. 点击实例ID进入详情页
4. 点击 **安全组** 标签页
5. 点击安全组ID进入安全组规则
6. 点击 **添加安全组规则**
7. 配置：
   - **规则方向**：入方向
   - **授权策略**：允许
   - **协议类型**：自定义TCP
   - **端口范围**：22/22
   - **授权对象**：0.0.0.0/0
8. 点击 **保存**

#### 腾讯云CVM
1. 登录腾讯云控制台
2. 进入 **云服务器** → **实例**
3. 找到服务器，点击实例ID
4. 点击 **安全组** 标签
5. 点击安全组ID → **修改规则**
6. 点击 **添加规则**
7. 配置：
   - **类型**：自定义
   - **来源**：0.0.0.0/0
   - **协议端口**：TCP:22
   - **策略**：允许
8. 保存

#### 华为云ECS
1. 登录华为云控制台
2. 进入 **弹性云服务器** → **实例**
3. 找到服务器，点击 **安全组**
4. 点击安全组名称
5. 点击 **添加规则** → **入方向规则**
6. 配置：
   - **协议**：TCP
   - **端口**：22
   - **源地址**：0.0.0.0/0
7. 保存

### 方案2：重启服务器（如果控制台无法连接）

1. 在云控制台找到 **重启** 按钮
2. 点击重启（选择"强制重启"如果普通重启无效）
3. 等待 1-2 分钟服务器重启完成
4. 尝试重新连接

**注意**：重启后如果UFW未配置开机自启，防火墙可能是关闭状态，SSH可能恢复。

### 方案3：使用云服务商的救援模式（如果支持）

部分云服务商提供救援模式，可以挂载系统盘到救援实例：
- **阿里云**：云服务器ECS → 实例 → 更多 → 云助手/运维助手
- **腾讯云**：云服务器 → 救援模式
- **华为云**：弹性云服务器 → 救援模式

### 方案4：检查控制台是否有VNC连接

有些云服务商提供VNC连接，不依赖SSH：
- 查看控制台是否有 **VNC连接** 或 **远程桌面** 选项
- VNC通常使用不同端口，不受UFW影响

## 恢复连接后的操作

成功连接后，立即执行：

```bash
# 1. 开放SSH端口22（防止再次被阻止）
sudo ufw allow 22/tcp

# 2. 检查防火墙状态
sudo ufw status

# 3. 确认22端口已开放
# 应该看到类似：22/tcp                     ALLOW       Anywhere

# 4. 如果需要，开放其他端口
sudo ufw allow 8080/tcp
sudo ufw allow 5173/tcp
sudo ufw allow 8765/tcp

# 5. 重新加载防火墙
sudo ufw reload
```

## 预防措施

已经修复了 `setup_firewall.sh` 脚本，现在会在启用防火墙前先开放22端口。

下次部署时，使用修复后的脚本即可避免此问题。

